<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åœ°ç‚¹ãƒãƒƒãƒ—</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}

  .row{display:grid;grid-template-columns:1fr 180px;gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  select,button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff;cursor:pointer;font-weight:700}

  #map{height:60vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}
  .divider{height:1px;background:var(--line);margin:12px 0}

  .group-ui{display:grid;gap:8px;margin-top:10px}
  details.group{border:1px solid var(--line);border-radius:10px;background:#fff}
  details.group > summary{list-style:none;cursor:pointer;padding:10px 12px;display:flex;align-items:center;gap:10px;font-weight:700;}
  details.group[open] > summary{border-bottom:1px solid var(--line);}
  .dot{width:14px;height:14px;border-radius:50%}
  .count{margin-left:auto;color:var(--muted);font-weight:600}
  .plist{margin:0;padding:8px 10px 10px;list-style:none;display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .item{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 8px;border-radius:8px}
  .item:hover{background:#f2f2f2}

  .badge{min-width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
  .nm{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px}

  /* ãƒ”ãƒ³ï¼ˆç•ªå·ï¼‹å½¢å¯¾å¿œï¼‰ */
  .pin-base{width:28px;height:28px;color:#fff;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.95);box-shadow:0 2px 6px rgba(0,0,0,.35);line-height:1;}
  .pin-circle{border-radius:50%;}
  .pin-square{border-radius:6px;}
  .pin-diamond{width:26px;height:26px;transform:rotate(45deg);border-radius:6px;}
  .pin-diamond>span{transform:rotate(-45deg);display:inline-block;}

  .gmaps-link{color:#1976d2;text-decoration:none;font-weight:700;}
  .gmaps-link:hover{text-decoration:underline;}

  /* ç”»é¢å³ä¸Šã®è‡ªå·±è¨ºæ–­ãƒãƒƒã‚¸ */
  #diag{position:fixed;right:10px;top:10px;z-index:9999;background:#d32f2f;color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;display:none}
</style>
</head>

<body>
<div id="diag"></div>

<div class="wrap">
  <div class="card" style="padding:14px;">
    <p class="h">åœ°ç‚¹ãƒãƒƒãƒ—</p>

    <!-- ãƒªã‚¹ãƒˆé¸æŠ -->
    <div class="row">
      <div class="ctl">
        <label>ãƒªã‚¹ãƒˆé¸æŠ</label>
        <select id="dataset"></select>
      </div>
      <div class="ctl">
        <label>&nbsp;</label>
        <button id="reload">è¡¨ç¤º</button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ï¼ˆä¸Šï¼‰ -->
    <div id="groupList" class="group-ui"></div>

    <div class="divider"></div>

    <!-- åœ°å›³ï¼ˆä¸‹ï¼‰ -->
    <div id="map"></div>

    <div class="divider"></div>

    <!-- å…ƒãƒ‡ãƒ¼ã‚¿ãƒœã‚¿ãƒ³ï¼ˆä¸€ç•ªä¸‹ï¼‰ -->
    <div style="display:flex;justify-content:flex-end;">
      <button id="openRaw">å…ƒãƒ‡ãƒ¼ã‚¿ã‚’é–‹ã</button>
    </div>

  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const $ = s => document.querySelector(s);
function showDiag(msg){
  const d=$("#diag"); d.textContent=msg; d.style.display="inline-block";
  console.error(msg);
}
function safeRun(fn,msg){
  try{ fn(); }catch(e){ showDiag((msg?msg+": ":"")+e.message); }
}

/* ===== è¨­å®š ===== */
const MANIFEST_URL = "data/manifest.json";

/* ===== åœ°å›³åˆæœŸåŒ– ===== */
const map = L.map('map').setView([27.0, 128.4], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'&copy; OpenStreetMap'
}).addTo(map);
let layerGroup = L.layerGroup().addTo(map);

/* ===== å‚ç…§ ===== */
const dsSel=$("#dataset"), btnReload=$("#reload"), btnOpen=$("#openRaw"), groupList=$("#groupList");

/* ===== çŠ¶æ…‹ ===== */
let manifest=[], rows=[], markers=[], grpColors={};

/* ===== è¦‹å‡ºã—ã®æ¤œå‡º ===== */
const NAME=["åç§°","åå‰","åœ°ç‚¹å","å","name","title"];
const LAT =["ç·¯åº¦","lat","latitude"];
const LNG =["çµŒåº¦","lng","long","longitude"];
const DESC=["èª¬æ˜","note","desc","å‚™è€ƒèª¬æ˜","èª¬æ˜æ–‡","è§£èª¬","remarks","memo"];
const GRP =["å‚™è€ƒ","ã‚°ãƒ«ãƒ¼ãƒ—","ã‚«ãƒ†ã‚´ãƒª","åŒºåˆ†","åˆ†é¡","ç­","ãƒ–ãƒ­ãƒƒã‚¯","group","category","class"];
const NUM =["ç•ªå·","No","no","num","id","ID"];
const SHP =["å½¢","shape","è¨˜å·","marker"];
const URLS=["URL","url","Url","ãƒªãƒ³ã‚¯","Google","StreetView","SV","sv_url","sv","streetview"];
const PHT =["å†™çœŸ","ç”»åƒ","å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«","ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«","photo","image","img"];
const GRAPH=["ã‚°ãƒ©ãƒ•URL","ã‚°ãƒ©ãƒ•","graph","chart","æ¸©åº¦ã‚°ãƒ©ãƒ•","ãŠã‚“ã©ã¨ã‚Š","ãŠã‚“ã©ã¨ã‚Šweb","ãŠã‚“ã©ã¨ã‚ŠWebStorage"];

function normalizeHeader(s){
  return String(s).replace(/[\u3000\s]+/g,"").toLowerCase();
}
function findKey(headers, candidates){
  const norm = headers.map(h=>normalizeHeader(h));
  for(const cand of candidates){
    const i = norm.indexOf(normalizeHeader(cand));
    if(i>=0) return headers[i];
  }
  return null;
}

/* ===== å€¤æ­£è¦åŒ– ===== */
function normShape(v){
  const s=(v??"").toString().toLowerCase();
  if(s.includes("å››")||s.includes("â–¡")||s.includes("square")) return "square";
  if(s.includes("ã²")||s.includes("è±")||s.includes("dia")||s.includes("diamond")) return "diamond";
  return "circle";
}
function parseNum(v){
  const n=Number(String(v).replace(/[^\d\.\-]/g,""));
  return Number.isFinite(n)?n:NaN;
}
function color(grp,i){
  const P=["#e6194b","#3cb44b","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28"];
  if(grpColors[grp])return grpColors[grp];
  grpColors[grp]=P[i%P.length]; return grpColors[grp];
}
function icon(label,c,s){
  const html = s==="diamond"
    ? `<div class="pin-base pin-diamond" style="background:${c}"><span>${label}</span></div>`
    : s==="square"
      ? `<div class="pin-base pin-square" style="background:${c}">${label}</div>`
      : `<div class="pin-base pin-circle" style="background:${c}">${label}</div>`;
  return L.divIcon({
    html,
    className:"",
    iconSize:[28,28],
    iconAnchor:[14,14],
    popupAnchor:[0,-14]
  });
}

/* ===== Googleãƒãƒƒãƒ—ï¼ˆé€šå¸¸åœ°å›³ï¼‰ ===== */
function mapsHrefForRow(r, urlK, lat, lng){
  const latN = Number(lat), lngN = Number(lng);
  if (Number.isFinite(latN) && Number.isFinite(lngN)) {
    return `https://www.google.com/maps/search/?api=1&query=${latN},${lngN}&source=web`;
  }
  const name = (r._name ?? "").toString().trim();
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name)}&source=web`;
}

/* ===== é‡ãªã‚Šè§£æ¶ˆï¼ˆ6mãƒªãƒ³ã‚°ï¼‰ ===== */
function offsetLatLng(lat, lng, idx, total){
  const ringSize = 8;
  const stepM = 6;
  const ring = Math.floor(idx / ringSize) + 1;
  const pos  = idx % ringSize;
  const countThisRing = Math.min(ringSize, total - ringSize*(ring-1));
  const angle = (2 * Math.PI / countThisRing) * pos;
  const radiusM = stepM * ring;
  const latRad = lat * Math.PI / 180;
  const dLat = (radiusM * Math.sin(angle)) / 111320;
  const dLng = (radiusM * Math.cos(angle)) / (111320 * Math.cos(latRad));
  return { lat: lat + dLat, lng: lng + dLng };
}

/* ===== ã‚°ãƒ«ãƒ¼ãƒ—UI ===== */
function buildGroupUI(groups, by){
  groupList.innerHTML="";
  groups.forEach((g,i)=>{
    const det=document.createElement("details"); det.className="group";
    const sum=document.createElement("summary");
    const dot=document.createElement("span"); dot.className="dot"; dot.style.background=color(g,i);
    const lbl=document.createElement("span"); lbl.textContent=g||"(ç©ºç™½)";
    const cnt=document.createElement("span"); cnt.className="count"; cnt.textContent=by[g].length+" ä»¶";
    sum.append(dot,lbl,cnt);

    const ul=document.createElement("ul"); ul.className="plist";
    by[g].forEach(rec=>{
      const li=document.createElement("li"); li.className="item";
      li.addEventListener("click",()=>{
        const mm=markers.find(m=>m.id===rec._id);
        if(!mm)return;
        $("#map").scrollIntoView({behavior:"smooth", block:"start"});
        map.setView(mm.marker.getLatLng(),15);
        mm.marker.openPopup();
      });

      const badge=document.createElement("span");
      badge.className="badge"; badge.style.background=color(g,i); badge.textContent=rec._label;
      const name=document.createElement("span"); name.className="nm"; name.textContent=rec._name;

      li.append(badge,name);

      // â˜… ã“ã“ã§ã€Œã‚°ãƒ©ãƒ•ã‚’é–‹ãã€ãƒªãƒ³ã‚¯ã‚’è¿½åŠ ï¼ˆURLãŒã‚ã‚‹ã¨ãã ã‘ï¼‰
      if(rec._graphUrl){
        const link = document.createElement("a");
        link.href = rec._graphUrl;
        link.textContent = "ã‚°ãƒ©ãƒ•ã‚’é–‹ã";
        link.target = "_blank";
        link.rel = "noopener";
        link.style.marginLeft = "8px";
        link.style.fontSize = "12px";
        link.style.color = "#1976d2";
        li.append(link);
      }

      ul.append(li);
    });

    det.append(sum,ul);
    groupList.append(det);
  });
}

/* ===== æç”» ===== */
function render(){
  if(!rows.length){ showDiag("ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™"); return; }
  const headers = Object.keys(rows[0]||{});
  if(headers.length===0){ showDiag("ã‚·ãƒ¼ãƒˆãŒç©ºã‹ã€ãƒ˜ãƒƒãƒ€è¡ŒãŒèª­ã‚ã¾ã›ã‚“"); return; }

  const nameK=findKey(headers,NAME) || "åç§°";
  const latK =findKey(headers,LAT)  || "ç·¯åº¦";
  const lngK =findKey(headers,LNG)  || "çµŒåº¦";

  if(!rows[0].hasOwnProperty(nameK) || !rows[0].hasOwnProperty(latK) || !rows[0].hasOwnProperty(lngK)){
    showDiag(`å¿…é ˆåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆåç§°/ç·¯åº¦/çµŒåº¦ï¼‰: name=${nameK} lat=${latK} lng=${lngK}`);
    return;
  }

  const descK  = findKey(headers,DESC);
  const grpK   = findKey(headers,GRP);
  const numK   = findKey(headers,NUM);
  const shpK   = findKey(headers,SHP);
  const urlK   = findKey(headers,URLS);
  const photoK = findKey(headers,PHT);
  const graphK = findKey(headers,GRAPH);

  layerGroup.clearLayers(); markers=[]; grpColors={};
  const by={}, groups=[];
  let seq=1, id=1;
  const ms=[];

  // åŒä¸€ç‚¹ä»¶æ•°
  const dupMap = new Map();
  const keyOf = (lat,lng)=>`${(+lat).toFixed(6)},${(+lng).toFixed(6)}`;
  rows.forEach(r=>{
    const latVal=parseNum(r[latK]), lngVal=parseNum(r[lngK]);
    const name=(r[nameK]??"").toString().trim();
    if(!name || !Number.isFinite(latVal) || !Number.isFinite(lngVal)) return;
    const k = keyOf(latVal, lngVal);
    const info = dupMap.get(k) || { total:0, next:0 };
    info.total++; dupMap.set(k, info);
  });

  // å®Ÿé…ç½®
  rows.forEach(r=>{
    const name=(r[nameK]??"").toString().trim();
    const latVal=parseNum(r[latK]), lngVal=parseNum(r[lngK]);
    if(!name || !Number.isFinite(latVal) || !Number.isFinite(lngVal)) return;

    const grp=grpK?(r[grpK]??"").toString().trim():"";
    let label=numK?(r[numK]??"").toString().trim():"";
    if(label==="") label=String(seq++);
    const shp = shpK ? normShape(r[shpK]) : "circle";
    const gi = groups.indexOf(grp)>=0 ? groups.indexOf(grp) : (groups.push(grp)-1 + 1);
    const c  = color(grp, gi);

    const k = keyOf(latVal, lngVal);
    const info = dupMap.get(k);
    let lat = latVal, lng = lngVal;
    if(info && info.total > 1){
      const idx = info.next++;
      const p = offsetLatLng(latVal, lngVal, idx, info.total);
      lat = p.lat; lng = p.lng;
    }

    const href = mapsHrefForRow({_name:name}, urlK, lat, lng);
    const desc = descK ? (r[descK]??"").toString() : "";

    // å†™çœŸãƒªãƒ³ã‚¯
    let photoHtml = "";
    if (photoK) {
      const raw = (r[photoK] ?? "").toString().trim();
      if (raw) {
        let photoUrl = "";
        if (/^https?:\/\//i.test(raw)) {
          photoUrl = raw;
        } else if (raw.startsWith("/")) {
          photoUrl = location.origin + raw;
        } else if (raw.includes("/")) {
          photoUrl = location.origin + "/" + raw;
        } else {
          let fname = raw;
          if (!/\.[a-z0-9]+$/i.test(fname)) {
            fname = fname + ".jpg";
          }
          photoUrl = "icons/" + fname;
        }
        photoHtml = `
          <br>
          <a href="${photoUrl}" target="_blank" rel="noopener"
             style="color:#1976d2;font-weight:700;text-decoration:none;">
            ğŸ“· å†™çœŸã‚’è¦‹ã‚‹
          </a>`;
      }
    }

    const pop = `<b>${name}</b>${desc ? `<br>${desc}` : ""}${photoHtml}<br>
                 <small><a class="gmaps-link" href="${href}" target="_blank" rel="noopener">Googleãƒãƒƒãƒ—ã§é–‹ã</a></small><br>
                 <small>ã‚°ãƒ«ãƒ¼ãƒ—: ${grp||"(ç©ºç™½)"}</small>`;

    const m=L.marker([lat,lng],{icon:icon(label,c,shp)}).bindPopup(pop);
    m.addTo(layerGroup);
    markers.push({id, marker:m, grp});

    // â˜… ã‚°ãƒ©ãƒ•ç”¨URLã‚’ã“ã“ã§ã‚»ãƒƒãƒˆ
    const graphUrl = graphK ? (r[graphK] ?? "").toString().trim() : "";

    if(!by[grp]) by[grp]=[];
    by[grp].push({_id:id, _label:label, _name:name, _graphUrl:graphUrl});
    ms.push(m);
    id++;
  });

  if(ms.length){
    const g=L.featureGroup(ms); map.fitBounds(g.getBounds().pad(0.2));
    buildGroupUI(Object.keys(by), by);
  }else{
    showDiag("æœ‰åŠ¹è¡ŒãŒ0ä»¶ã§ã—ãŸï¼ˆåç§°/ç·¯åº¦/çµŒåº¦ã‚’ç¢ºèªï¼‰");
    groupList.innerHTML="";
  }
}

/* ===== èª­ã¿è¾¼ã¿ ===== */
async function fetchRows(item){
  const res = await fetch(item.url,{cache:"no-store"});
  if(!res.ok){ showDiag(`ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ${item.url}`); return []; }
  const buf = await res.arrayBuffer();
  const wb = XLSX.read(buf,{type:"array"});
  const sh = wb.Sheets[wb.SheetNames[0]];
  if(!sh){ showDiag("æœ€åˆã®ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return []; }
  return XLSX.utils.sheet_to_json(sh,{defval:""});
}

/* ===== manifest èª­ã¿è¾¼ã¿ & é¸æŠ ===== */
async function loadManifest(){
  const res = await fetch(MANIFEST_URL, {cache:"no-store"});
  if(!res.ok){ showDiag("data/manifest.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return []; }
  const m = await res.json();
  if(!Array.isArray(m) || !m.length){ showDiag("manifest.json ãŒç©ºã§ã™"); return []; }
  return m;
}
async function loadSelected(){
  const idx = Number(dsSel.value ?? 0);
  const item = manifest[idx];
  if(!item){ showDiag("é¸æŠãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™"); return; }
  btnOpen.onclick = ()=> window.open(item.url, "_blank", "noopener");
  rows = await fetchRows(item);
  render();
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
btnReload.addEventListener("click", ()=>safeRun(loadSelected,"è¡¨ç¤ºã‚¨ãƒ©ãƒ¼"));
dsSel.addEventListener("change", ()=>safeRun(loadSelected,"è¡¨ç¤ºã‚¨ãƒ©ãƒ¼"));

/* ===== èµ·å‹• ===== */
(async ()=>{
  try{
    manifest = await loadManifest();
    if(!manifest.length) return;
    dsSel.innerHTML = manifest.map((d,i)=>`<option value="${i}">${d.name}</option>`).join("");
    dsSel.value = "0";
    await loadSelected();
  }catch(e){
    showDiag("åˆæœŸåŒ–å¤±æ•—: "+e.message);
  }
})();
</script>

<!-- PWA SW ç™»éŒ² -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js").catch(e=>{
    const d=document.getElementById("diag");
    d.textContent="SWç™»éŒ²å¤±æ•—: "+e.message; d.style.display="inline-block";
    console.error(e);
  });
}
</script>
</body>
</html>
