<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地点マップ</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">

<!-- iOS（ホーム画面追加→アプリ表示） -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}

  .row{display:grid;grid-template-columns:1fr 180px;gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  select,button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff;cursor:pointer;font-weight:700}

  #map{height:60vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}
  .divider{height:1px;background:var(--line);margin:12px 0}

  .group-ui{display:grid;gap:8px;margin-top:10px}
  details.group{border:1px solid var(--line);border-radius:10px;background:#fff}
  details.group > summary{list-style:none;cursor:pointer;padding:10px 12px;display:flex;align-items:center;gap:10px;font-weight:700;}
  details.group[open] > summary{border-bottom:1px solid var(--line);}
  .dot{width:14px;height:14px;border-radius:50%}
  .count{margin-left:auto;color:var(--muted);font-weight:600}
  .plist{margin:0;padding:8px 10px 10px;list-style:none;display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto}
  .item{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 8px;border-radius:8px}
  .item:hover{background:#f2f2f2}

  .badge{min-width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
  .nm{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:560px}

  .pin-base{width:28px;height:28px;color:#fff;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.95);box-shadow:0 2px 6px rgba(0,0,0,.35);line-height:1;}
  .pin-circle{border-radius:50%;}
  .pin-square{border-radius:6px;}
  .pin-diamond{width:26px;height:26px;transform:rotate(45deg);border-radius:6px;}
  .pin-diamond>span{transform:rotate(-45deg);display:inline-block;}

  .gmaps-link{color:#1976d2;text-decoration:none;font-weight:700;}
  .gmaps-link:hover{text-decoration:underline;}

  @media(max-width:600px){ .row{grid-template-columns:1fr 1fr;} }
</style>
</head>

<body>
<div class="wrap">
  <div class="card" style="padding:14px;">
    <p class="h">地点マップ</p>

    <!-- リスト選択 -->
    <div class="row">
      <div class="ctl">
        <label>リスト選択</label>
        <select id="dataset"></select>
      </div>
      <div class="ctl">
        <label>&nbsp;</label>
        <button id="reload">表示</button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- グループ一覧 -->
    <div id="groupList" class="group-ui"></div>

    <div class="divider"></div>

    <!-- 地図 -->
    <div id="map"></div>

    <div class="divider"></div>

    <!-- 元データ -->
    <div style="display:flex;justify-content:flex-end;">
      <button id="openRaw">元データを開く</button>
    </div>

  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ========= 基本設定 ========= */
const MANIFEST_URL = "data/manifest.json";

const $=s=>document.querySelector(s);
const dsSel=$("#dataset"), btnReload=$("#reload"), btnOpen=$("#openRaw");

/* ========= 地図 ========= */
const map = L.map('map').setView([27.0,128.4],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let layerGroup = L.layerGroup().addTo(map);

/* ========= 重なりズラし ========= */
function offset(lat,lng,i,total){
  const ring= Math.floor(i/8)+1;
  const pos = i%8;
  const rad = (2*Math.PI/Math.min(8,total))*pos;
  const r = 6*ring;
  const dLat=(r*Math.sin(rad))/111320;
  const dLng=(r*Math.cos(rad))/(111320*Math.cos(lat*Math.PI/180));
  return {lat:lat+dLat,lng:lng+dLng};
}

/* ========= Googleマップリンク（ストビュー起動しない） ========= */
function link(lat,lng,name){
  return `https://www.google.com/maps/search/?api=1&query=${lat},${lng}&source=web`;
}

/* ========= 描画 ========= */
async function loadSelected(){
  const idx=Number(dsSel.value);
  const item=manifest[idx];
  if(!item) return;

  btnOpen.onclick=()=>window.open(item.url,"_blank");

  const buf=await fetch(item.url,{cache:"no-store"}).then(r=>r.arrayBuffer());
  const wb=XLSX.read(buf,{type:"array"});
  const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});

  layerGroup.clearLayers();

  // 重複カウント
  const mapDup=new Map();
  function key(a,b){return `${(+a).toFixed(6)},${(+b).toFixed(6)}`;}
  rows.forEach(r=>{
    if(r.緯度 && r.経度){
      const k=key(r.緯度,r.経度);
      const o=mapDup.get(k)||{total:0,next:0};
      o.total++; mapDup.set(k,o);
    }
  });

  const groups={}, markers=[];
  rows.forEach(r=>{
    if(!r.名称 || !r.緯度 || !r.経度) return;
    const k=key(r.緯度,r.経度);
    const d=mapDup.get(k);
    let lat=r.緯度, lng=r.経度;
    if(d.total>1){
      const p=offset(r.緯度,r.経度,d.next++,d.total);
      lat=p.lat; lng=p.lng;
    }
    const m=L.marker([lat,lng]).bindPopup(
      `<b>${r.名称}</b><br><a class="gmaps-link" href="${link(lat,lng,r.名称)}" target="_blank">Googleマップで開く</a><br><small>${r.備考||""}</small>`
    );
    m.addTo(layerGroup);
  });

  // 地図全体表示
  const all=layerGroup.getLayers();
  if(all.length) map.fitBounds(L.featureGroup(all).getBounds().pad(0.2));
}

/* ========= manifest 読み込み ========= */
let manifest=[];
(async()=>{
  const res=await fetch(MANIFEST_URL,{cache:"no-store"});
  manifest=await res.json();
  dsSel.innerHTML=manifest.map((d,i)=>`<option value="${i}">${d.name}</option>`).join("");
  dsSel.value="0";
  loadSelected();
})();

/* ========= イベント ========= */
btnReload.onclick=loadSelected;
dsSel.onchange=loadSelected;
</script>

<!-- PWA SW -->
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
