<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地点マップ</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}
  .row{display:grid;grid-template-columns: 1fr 180px; gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input[type=file],button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff}
  button{cursor:pointer;font-weight:700}
  #map{height:58vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}

  .divider{height:1px; background:var(--line); margin:10px 0}

  /* グループリスト（階層） */
  .group-ui{display:grid; grid-template-columns: 1fr; gap:8px; margin-top:10px}
  details.group{border:1px solid var(--line); border-radius:10px; background:#fff}
  details.group > summary{
    list-style:none; cursor:pointer; padding:10px 12px; display:flex; align-items:center; gap:10px;
    font-weight:700;
  }
  details.group[open] > summary{ border-bottom:1px solid var(--line); }
  .dot{width:14px;height:14px;border-radius:50%}
  .count{margin-left:auto; color:var(--muted); font-weight:600}
  .plist{margin:0; padding:8px 10px 10px 10px; list-style:none; display:flex; flex-direction:column; gap:6px; max-height:220px; overflow:auto}
  .item{display:flex; align-items:center; gap:10px; cursor:pointer; padding:6px 8px; border-radius:8px}
  .item:hover{background:#f3f3f3}
  .badge{min-width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff}
  .nm{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 560px; }

  /* 番号ピン（丸/四角/ひし形） */
  .pin-base{
    width:28px; height:28px; color:#fff; font-weight:800; font-size:14px;
    display:flex; align-items:center; justify-content:center;
    border:2px solid rgba(255,255,255,.95);
    box-shadow:0 2px 6px rgba(0,0,0,.3); line-height:1; }
  .pin-circle{ border-radius:50%; }
  .pin-square{ border-radius:6px; }
  .pin-diamond{ width:26px; height:26px; transform: rotate(45deg); border-radius:6px; }
  .pin-diamond > span{ transform: rotate(-45deg); display:inline-block; }

  @media (max-width:820px){ .row{grid-template-columns:1fr 140px} }
  @media (max-width:560px){ .row{grid-template-columns:1fr} .plist{max-height:unset} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="padding:14px 14px 10px">
      <p class="h">地点マップ</p>
      <div class="row">
        <div class="ctl">
          <label>ファイル（.xlsx / .xls / .csv）</label>
          <input id="file" type="file" accept=".xlsx,.xls,.csv" />
        </div>
        <div class="ctl">
          <label>&nbsp;</label>
          <button id="plot">地図に表示</button>
        </div>
      </div>

      <div id="map"></div>

      <div class="divider"></div>

      <!-- グループ階層リスト -->
      <div id="groupList" class="group-ui"></div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Leaflet
    const map = L.map('map', { zoomControl: true }).setView([35,135], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    let layerGroup = L.layerGroup().addTo(map);

    const $ = s => document.querySelector(s);
    const groupList = $("#groupList");

    let rows = [];
    let markers = [];     // {id, marker, grp}
    let grpColors = {};   // {grp: color}

    // 自動認識キー
    const NAME_KEYS = ["名称","名前","地点名","ラベル","名","name","title"];
    const LAT_KEYS  = ["緯度","latitude","lat","Lat","LAT"];
    const LNG_KEYS  = ["経度","longitude","long","lng","Lon","LNG","lon"];
    const DESC_KEYS = ["説明","備考説明","注記","note","desc","description"];
    const GRP_KEYS  = ["備考","グループ","カテゴリ","区分","分類","班","ブロック","group","category","class"];
    const NUM_KEYS  = ["番号","No","no","num","番号No"];
    const SHP_KEYS  = ["形","形状","マーカー形","shape","marker","記号"];

    $("#file").addEventListener("change", async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:"array" });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:"", raw:true });
      if(json.length === 0){ alert("データが空です。1行目=ヘッダー、2行目以降=データにしてください。"); return; }
      rows = json;
    });

    // 色
    const PALETTE = [
      "#e6194b","#3cb44b","#0082c8","#f58231","#911eb4",
      "#46f0f0","#f032e6","#d2f53c","#fabebe","#008080",
      "#e6beff","#aa6e28","#fffac8","#800000","#aaffc3",
      "#808000","#ffd8b1","#000080","#808080","#ffe119"
    ];
    function colorForGroup(grp, i){
      if(grpColors[grp]) return grpColors[grp];
      const c = i < PALETTE.length ? PALETTE[i] : `hsl(${(i*57)%360} 75% 45%)`;
      grpColors[grp] = c; return c;
    }

    // 正規化
    function normShape(v){
      const s = (v ?? "").toString().trim().toLowerCase();
      if(["四角","しかく","square","□","正方形","長方形"].some(k=>s.includes(k))) return "square";
      if(["ひし","菱","diamond","ダイヤ"].some(k=>s.includes(k))) return "diamond";
      return "circle";
    }
    function parseNum(v){
      const n = Number((v ?? "").toString().replace(/[^\d\.\-]/g,""));
      return Number.isFinite(n) ? n : NaN;
    }

    function numberIcon(label, color, shape){
      const safe = (label ?? "").toString();
      let html = "";
      if(shape === "diamond"){
        html = `<div class="pin-base pin-diamond" style="background:${color};border-color:${color};"><span>${safe}</span></div>`;
      }else if(shape === "square"){
        html = `<div class="pin-base pin-square"  style="background:${color};border-color:${color};">${safe}</div>`;
      }else{
        html = `<div class="pin-base pin-circle"  style="background:${color};border-color:${color};">${safe}</div>`;
      }
      return L.divIcon({ html, className:"", iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-14] });
    }

    function autoKey(headers, keys){
      const lower = headers.map(h=>h.toString().toLowerCase());
      for(const k of keys){
        const i = lower.indexOf(k.toLowerCase());
        if(i>=0) return headers[i];
      }
      return null;
    }

    // グループ階層UI
    function buildGroupList(groups, recordsByGroup){
      groupList.innerHTML = "";
      groups.forEach((g, i)=>{
        const color = colorForGroup(g, i);
        const det = document.createElement("details");
        det.className = "group";
        det.open = true;

        const sum = document.createElement("summary");
        const dot = document.createElement("span"); dot.className="dot"; dot.style.background = color;
        const lbl = document.createElement("span"); lbl.textContent = g || "(空白)";
        const cnt = document.createElement("span"); cnt.className="count"; cnt.textContent = recordsByGroup[g].length + " 件";
        sum.append(dot, lbl, cnt);

        const ul = document.createElement("ul"); ul.className = "plist";

        recordsByGroup[g].forEach(rec=>{
          const li = document.createElement("li"); li.className = "item"; li.dataset.id = rec._id;
          const badge = document.createElement("span"); badge.className="badge"; badge.style.background = color; badge.textContent = rec._label;
          const name = document.createElement("span"); name.className="nm"; name.textContent = rec._name;
          li.append(badge, name);
          li.addEventListener("click", ()=>{
            const mm = markers.find(m=>m.id === rec._id);
            if(mm){ mm.marker.openPopup(); map.setView(mm.marker.getLatLng(), Math.max(map.getZoom(), 15)); }
          });
          ul.appendChild(li);
        });

        det.append(sum, ul);
        groupList.appendChild(det);
      });
    }

    // 描画（番号のみ表示）
    $("#plot").addEventListener("click", ()=>{
      if(rows.length===0){ alert("先にファイルを選んでください。"); return; }

      const headers = Object.keys(rows[0]);
      const nameKey = autoKey(headers, NAME_KEYS);
      const latKey  = autoKey(headers, LAT_KEYS);
      const lngKey  = autoKey(headers, LNG_KEYS);
      if(!nameKey || !latKey || !lngKey){
        alert([
          "必要な列が不足しています。",
          `名称=${nameKey||"×"} / 緯度=${latKey||"×"} / 経度=${lngKey||"×"}`
        ].join("\n"));
        return;
      }
      const descKey = autoKey(headers, DESC_KEYS); // 任意
      const grpKey  = autoKey(headers, GRP_KEYS);  // 備考 等（任意）
      const numKey  = autoKey(headers, NUM_KEYS);  // 任意
      const shpKey  = autoKey(headers, SHP_KEYS);  // 任意

      // グループ → レコードのマップ
      const byGroup = {};
      const groupsOrder = [];

      layerGroup.clearLayers();
      grpColors = {};
      markers = [];
      const ms = [];
      let autoNum = 1;
      let nextId = 1;

      rows.forEach(r=>{
        const name = (r[nameKey] ?? "").toString().trim();
        const lat  = parseNum(r[latKey]);
        const lng  = parseNum(r[lngKey]);
        if(!name || !Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const desc = descKey ? (r[descKey] ?? "").toString() : "";
        const grp  = grpKey ? (r[grpKey] ?? "").toString().trim() : "";
        const shp  = shpKey ? normShape(r[shpKey]) : "circle";

        // ラベル＝番号（なければ連番）
        let label = numKey ? (r[numKey] ?? "").toString().trim() : "";
        if(label === "") label = String(autoNum++);
        const color = colorForGroup(grp, groupsOrder.indexOf(grp) >= 0 ? groupsOrder.indexOf(grp) : groupsOrder.push(grp)-1 + 1);

        const icon  = numberIcon(label, color, shp);
        const html  = `<b>${name}</b>${desc?`<br>${desc}`:''}${grpKey?`<br><small style="color:#666">グループ: ${grp||"(空白)"} / 形: ${shp}</small>`:''}`;

        const marker = L.marker([lat,lng], {icon}).bindPopup(html);
        const id = nextId++;
        markers.push({id, marker, grp});
        ms.push(marker);

        // グループ別配列
        if(!byGroup[grp]) byGroup[grp] = [];
        byGroup[grp].push({_id:id, _label: label, _name: name});
      });

      if(ms.length===0){ alert("有効な行がありません（名称・緯度・経度を確認）。"); groupList.innerHTML=""; return; }

      ms.forEach(m=>m.addTo(layerGroup));
      const group = L.featureGroup(ms); map.fitBounds(group.getBounds().pad(0.2));

      // グループ名の出現順で並べる
      const groups = Object.keys(byGroup);
      buildGroupList(groups, byGroup);
    });
  </script>
</body>
</html>
