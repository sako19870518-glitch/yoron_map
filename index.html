<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>地点マップ（内蔵リスト選択・URL優先）</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  :root{ --bg:#fafafa; --ink:#111; --muted:#6b6b6b; --line:#dcdcdc; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Yu Gothic",Meiryo,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
  .h{font-weight:800;font-size:18px;margin:0 0 8px}

  .row{display:grid;grid-template-columns: 1fr 220px 140px; gap:10px}
  .ctl{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  select,button{height:44px;border:1px solid var(--line);border-radius:10px;font-size:14px;padding:0 10px;background:#fff}
  button{cursor:pointer;font-weight:700}

  #map{height:58vh;border-radius:12px;border:1px solid var(--line);margin-top:12px}
  .divider{height:1px; background:var(--line); margin:10px 0}

  .group-ui{display:grid; gap:8px; margin-top:10px}
  details.group{border:1px solid var(--line); border-radius:10px; background:#fff}
  details.group > summary{list-style:none; cursor:pointer; padding:10px 12px; display:flex; align-items:center; gap:10px; font-weight:700;}
  details.group[open] > summary{ border-bottom:1px solid var(--line); }
  .dot{width:14px;height:14px;border-radius:50%}
  .count{margin-left:auto; color:var(--muted); font-weight:600}
  .plist{margin:0; padding:8px 10px 10px 10px; list-style:none; display:flex; flex-direction:column; gap:6px; max-height:220px; overflow:auto}
  .item{display:flex; align-items:center; gap:10px; cursor:pointer; padding:6px 8px; border-radius:8px}
  .item:hover{background:#f3f3f3}
  .badge{min-width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff}
  .nm{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 560px; }

  .pin-base{width:28px; height:28px; color:#fff; font-weight:800; font-size:14px;
    display:flex; align-items:center; justify-content:center; border:2px solid rgba(255,255,255,.95);
    box-shadow:0 2px 6px rgba(0,0,0,.3); line-height:1; }
  .pin-circle{ border-radius:50%; } .pin-square{ border-radius:6px; }
  .pin-diamond{ width:26px; height:26px; transform: rotate(45deg); border-radius:6px; }
  .pin-diamond > span{ transform: rotate(-45deg); display:inline-block; }

  .gmaps-link{ color:#1976d2; text-decoration:none; } .gmaps-link:hover{ text-decoration:underline; }

  @media (max-width:820px){ .row{grid-template-columns:1fr 1fr } }
  @media (max-width:560px){ .row{grid-template-columns:1fr } .plist{max-height:unset} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="padding:14px 14px 10px">
      <p class="h">地点マップ</p>
      <div class="row">
        <div class="ctl">
          <label>内蔵リスト</label>
          <select id="dataset"></select>
        </div>
        <div class="ctl">
          <label>&nbsp;</label>
          <button id="reload">このリストを表示</button>
        </div>
        <div class="ctl">
          <label>&nbsp;</label>
          <button id="openRaw">元データを開く</button>
        </div>
      </div>

      <div id="map"></div>

      <div class="divider"></div>
      <div id="groupList" class="group-ui"></div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ====== 設定 ====== */
const MANIFEST_URL = "data/manifest.json";

/* ====== 地図 ====== */
const map = L.map('map').setView([27.0, 128.4], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
let layerGroup = L.layerGroup().addTo(map);

const $=s=>document.querySelector(s);
const dsSel=$("#dataset"), btnReload=$("#reload"), btnOpen=$("#openRaw"), groupList=$("#groupList");

let manifest=[], rows=[], markers=[], grpColors={};
function assert(b,msg){ if(!b) throw new Error(msg); }

/* ====== 列 推測（見出しの空白・全角空白・大文字小文字を吸収） ====== */
const NAME=["名称","名前","地点名","名","name","title"];
const LAT=["緯度","lat","latitude"];
const LNG=["経度","lng","long","longitude"];
const DESC=["説明","note","desc","備考説明","説明文","解説"];
const GRP=["備考","グループ","カテゴリ","区分","分類","班","ブロック","group","category","class"];
const NUM=["番号","No","no","num","id","ID"];
const SHP=["形","shape","記号","marker"];
const URLS=["URL","url","Url","リンク","Google","StreetView","SV","sv_url","sv","streetview"];

function normalizeHeader(s){
  return String(s).replace(/[\u3000\s]+/g,"").toLowerCase(); // 全角空白も削除 → 小文字
}
function findKey(headers, candidates){
  const norm = headers.map(h=>normalizeHeader(h));
  for(const cand of candidates){
    const i = norm.indexOf(normalizeHeader(cand));
    if(i>=0) return headers[i]; // 元のキー名を返す（値取得に使う）
  }
  return null;
}

/* ====== 形・数値など ====== */
function normShape(v){
  const s=(v??"").toString().toLowerCase();
  if(s.includes("四")||s.includes("□")||s.includes("square")) return "square";
  if(s.includes("ひ")||s.includes("菱")||s.includes("dia")||s.includes("diamond")) return "diamond";
  return "circle";
}
function parseNum(v){
  const n=Number(String(v).replace(/[^\d\.\-]/g,""));
  return Number.isFinite(n)?n:NaN;
}
function color(grp,i){
  const P=["#e6194b","#3cb44b","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28"];
  if(grpColors[grp])return grpColors[grp];
  grpColors[grp]=P[i%P.length]; return grpColors[grp];
}
function icon(label,c,s){
  const html = s==="diamond"
    ? `<div class="pin-base pin-diamond" style="background:${c}"><span>${label}</span></div>`
    : s==="square"
      ? `<div class="pin-base pin-square" style="background:${c}">${label}</div>`
      : `<div class="pin-base pin-circle" style="background:${c}">${label}</div>`;
  return L.divIcon({html,className:"",iconSize:[28,28],iconAnchor:[14,14],popupAnchor:[0,-14]});
}

/* ====== 読み込み ====== */
async function fetchArrayBuffer(url){
  const res = await fetch(url,{cache:"no-store"});
  assert(res.ok, `データ取得失敗: ${url}`);
  return res.arrayBuffer();
}
async function readArrayBufferToRows(buf){
  const wb = XLSX.read(buf,{type:"array"});
  return XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:""});
}

/* ====== UI構築 ====== */
function buildGroupUI(groups, by){
  groupList.innerHTML="";
  groups.forEach((g,i)=>{
    const det=document.createElement("details"); // デフォルト閉じる
    det.className="group";

    const sum=document.createElement("summary");
    const dot=document.createElement("span"); dot.className="dot"; dot.style.background=color(g,i);
    const lbl=document.createElement("span"); lbl.textContent=g||"(空白)";
    const cnt=document.createElement("span"); cnt.className="count"; cnt.textContent=by[g].length+" 件";
    sum.append(dot,lbl,cnt);

    const ul=document.createElement("ul"); ul.className="plist";
    by[g].forEach(rec=>{
      const li=document.createElement("li"); li.className="item";
      li.addEventListener("click",()=>{
        const mm=markers.find(m=>m.id===rec._id);
        if(!mm)return;
        document.getElementById("map").scrollIntoView({behavior:"smooth", block:"start"});
        map.setView(mm.marker.getLatLng(),15);
        mm.marker.openPopup();
      });
      const badge=document.createElement("span");
      badge.className="badge"; badge.style.background=color(g,i); badge.textContent=rec._label;
      const name=document.createElement("span"); name.className="nm"; name.textContent=rec._name;
      li.append(badge,name);
      ul.append(li);
    });

    det.append(sum,ul);
    groupList.append(det);
  });
}

/* ====== GoogleマップURL（優先順位） ======
   1) URL列に値があれば “そのまま” 使う（短縮URL含む・orientation保持）
   2) それ以外は lat,lng 検索リンク
*/
function mapsHrefForRow(r, urlK, lat, lng){
  if(urlK){
    const raw = (r[urlK]??"").toString().trim();
    if(raw) return raw; // 加工せずそのまま
  }
  return `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
}

/* ====== 描画 ====== */
function render(){
  if(!rows.length){ alert("データが空です"); return; }
  const headers = Object.keys(rows[0]);

  const nameK=findKey(headers,NAME), latK=findKey(headers,LAT), lngK=findKey(headers,LNG);
  if(!nameK||!latK||!lngK){
    alert(`必須列が見つかりません。\n名称=${nameK||"×"} / 緯度=${latK||"×"} / 経度=${lngK||"×"}`);
    return;
  }
  const descK=findKey(headers,DESC), grpK=findKey(headers,GRP), numK=findKey(headers,NUM), shpK=findKey(headers,SHP), urlK=findKey(headers,URLS);

  layerGroup.clearLayers(); markers=[]; grpColors={};
  const by={}, groups=[];
  let seq=1, id=1;
  const ms=[];

  rows.forEach(r=>{
    const name=(r[nameK]??"").toString().trim();
    const lat=parseNum(r[latK]), lng=parseNum(r[lngK]);
    if(!name || !Number.isFinite(lat) || !Number.isFinite(lng)) return;

    const grp=grpK?(r[grpK]??"").toString().trim():"";
    let label=numK?(r[numK]??"").toString().trim():"";
    if(label==="") label=String(seq++);
    const shp = shpK ? normShape(r[shpK]) : "circle";
    const gi = groups.indexOf(grp)>=0 ? groups.indexOf(grp) : (groups.push(grp)-1 + 1);
    const c  = color(grp, gi);

    const href = mapsHrefForRow(r, urlK, lat, lng); // ★ URL列を最優先で使用
    const pop = `<b>${name}</b>${descK?`<br>${(r[descK]??"").toString()}`:""}<br>
                 <small><a class="gmaps-link" href="${href}" target="_blank" rel="noopener">グループ: ${grp||"(空白)"} </a></small>`;

    const m=L.marker([lat,lng],{icon:icon(label,c,shp)}).bindPopup(pop);
    m.addTo(layerGroup);
    markers.push({id, marker:m, grp});

    if(!by[grp]) by[grp]=[];
    by[grp].push({_id:id, _label:label, _name:name});
    ms.push(m);
    id++;
  });

  if(ms.length){
    const g=L.featureGroup(ms); map.fitBounds(g.getBounds().pad(0.2));
    buildGroupUI(Object.keys(by), by);
  }else{
    alert("有効行が0件でした（名称/緯度/経度を確認）");
    groupList.innerHTML="";
  }
}

/* ====== manifest 読み込み & 選択 ====== */
async function loadManifest(){
  const res = await fetch(MANIFEST_URL, {cache:"no-store"});
  if(!res.ok){
    dsSel.innerHTML = `<option value="">manifestが見つかりません</option>`;
    throw new Error("manifest.json not found");
  }
  manifest = await res.json();
  if(!Array.isArray(manifest) || !manifest.length) throw new Error("manifestが空です");
  dsSel.innerHTML = manifest.map((d,i)=>`<option value="${i}">${d.name}</option>`).join("");
}
async function fetchRows(item){
  const buf = await fetchArrayBuffer(item.url);
  rows = await readArrayBufferToRows(buf);
}
async function loadSelected(){
  const idx = Number(dsSel.value ?? 0);
  const item = manifest[idx];
  if(!item) return;
  btnOpen.onclick = ()=> window.open(item.url, "_blank", "noopener");
  await fetchRows(item);
  render();
}

/* ====== イベント ====== */
btnReload.addEventListener("click", loadSelected);
dsSel.addEventListener("change", loadSelected);

/* ====== 起動 ====== */
(async ()=>{
  try{
    await loadManifest();
    dsSel.value = "0";
    await loadSelected();
  }catch(e){
    console.error(e);
    alert("初期化に失敗しました。data/manifest.json とデータファイルの配置を確認してください。");
  }
})();
</script>
</body>
</html>
